name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  issues:
    types: [opened, edited, labeled]

jobs:
  # Validate issue templates for bug reports and feature requests
  validate-issue:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: Validate Issue Template
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name.toLowerCase());
            const body = issue.body || '';
            const title = issue.title || '';
            
            let errors = [];
            let isBug = labels.includes('bug') || /\b(bug|error|fix|broken)\b/i.test(title);
            let isFeature = labels.includes('enhancement') || /\b(feature|enhancement|request)\b/i.test(title);
            
            // Validate bug reports
            if (isBug) {
              console.log('Validating bug report...');
              if (body.length < 50) {
                errors.push('Bug reports should have a detailed description (at least 50 characters)');
              }
              if (!/steps to reproduce|how to reproduce|reproduction/i.test(body)) {
                errors.push('Bug reports should include steps to reproduce');
              }
              if (!/expected|actual|behavior/i.test(body)) {
                errors.push('Bug reports should describe expected vs actual behavior');
              }
            }
            
            // Validate feature requests
            if (isFeature) {
              console.log('Validating feature request...');
              if (body.length < 30) {
                errors.push('Feature requests should have a description (at least 30 characters)');
              }
              if (!/use case|problem|why|benefit/i.test(body)) {
                errors.push('Feature requests should explain the use case or problem being solved');
              }
            }
            
            // Post validation results as comment
            if (errors.length > 0) {
              const comment = `## âš ï¸ Issue Validation\n\nPlease address the following:\n\n${errors.map(e => `- ${e}`).join('\n')}\n\n_This is an automated check to ensure quality issue reports._`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: comment
              });
              console.log('Validation issues found:', errors);
            } else {
              console.log('Issue validation passed!');
            }

  # Lint and test for PRs and pushes
  lint-and-test:
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black isort pytest

      - name: Run Black (code formatting)
        run: black --check --diff . || echo "::warning::Code formatting issues found. Run 'black .' to fix."
        continue-on-error: true

      - name: Run isort (import sorting)
        run: isort --check-only --diff . || echo "::warning::Import sorting issues found. Run 'isort .' to fix."
        continue-on-error: true

      - name: Run Flake8 (linting)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run Tests
        run: pytest tests/ -v --tb=short
        env:
          PYTHONDONTWRITEBYTECODE: 1

  # PR-specific checks
  pr-checks:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Check PR Labels and Linked Issues
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const labels = pr.labels.map(l => l.name.toLowerCase());
            const body = pr.body || '';
            
            let warnings = [];
            
            // Check if PR links to an issue
            const issuePattern = /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s*#\d+/i;
            if (!issuePattern.test(body) && !/#\d+/.test(body)) {
              warnings.push('Consider linking this PR to an issue using "Closes #XX" or "Fixes #XX"');
            }
            
            // Check for bug-related PRs
            if (labels.includes('bug')) {
              console.log('This PR is labeled as a bug fix');
              if (!/test|spec/i.test(body)) {
                warnings.push('Bug fix PRs should ideally include tests to prevent regression');
              }
            }
            
            // Check for feature PRs
            if (labels.includes('enhancement')) {
              console.log('This PR is labeled as an enhancement');
              if (!/documentation|docs|readme/i.test(body) && body.length < 100) {
                warnings.push('Feature PRs should include documentation updates if applicable');
              }
            }
            
            if (warnings.length > 0) {
              console.log('PR Suggestions:', warnings);
              // Post as comment for visibility
              const existingComments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number
              });
              
              const botComment = existingComments.data.find(c => 
                c.user.type === 'Bot' && c.body.includes('PR Validation')
              );
              
              const comment = `## ðŸ“‹ PR Validation\n\nSuggestions for this PR:\n\n${warnings.map(w => `- ${w}`).join('\n')}\n\n_This is an automated check._`;
              
              if (!botComment) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: comment
                });
              }
            }
